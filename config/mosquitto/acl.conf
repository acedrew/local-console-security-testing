# ============================================================================
# Eclipse Mosquitto Access Control List (ACL)
# Topic-level authorization for MQTT broker
# ============================================================================
# Format:
#   user <username>
#   topic [read|write|readwrite] <topic>
#
# Wildcards:
#   + : Single level wildcard (e.g., devices/+/status)
#   # : Multi-level wildcard (e.g., devices/#)
#
# Certificate-based authentication:
#   Username is derived from client certificate CN or Subject
# ============================================================================

# ----------------------------------------------------------------------------
# PKI Service Account
# ----------------------------------------------------------------------------
# The PKI service needs broad access for device verification
user pki-service

# Allow reading all device status messages
topic read devices/+/status

# Allow reading device verification responses
topic read devices/+/verify/response

# Allow publishing verification requests
topic write devices/+/verify/request

# Allow reading system topics for monitoring
topic read $SYS/broker/clients/connected
topic read $SYS/broker/clients/disconnected
topic read $SYS/broker/uptime

# ----------------------------------------------------------------------------
# Device Pattern ACLs
# ----------------------------------------------------------------------------
# Devices are authenticated by certificate CN (e.g., device-12345)
# Pattern-based ACL for all devices starting with "device-"

pattern read devices/%c/status
pattern write devices/%c/status
pattern read devices/%c/verify/request
pattern write devices/%c/verify/response
pattern read devices/%c/commands
pattern write devices/%c/telemetry

# Devices can read their own configuration
pattern read config/%c/#

# Devices cannot read other devices' topics
# (enforced by not granting wildcard permissions)

# ----------------------------------------------------------------------------
# Admin Users
# ----------------------------------------------------------------------------
# Admin can access all topics (monitoring and management)
user admin

# Full access to all topics
topic readwrite #

# System topics
topic read $SYS/#

# ----------------------------------------------------------------------------
# Monitoring Service
# ----------------------------------------------------------------------------
user monitoring-service

# Read-only access to device topics
topic read devices/#

# Read-only access to system topics
topic read $SYS/#

# Cannot write to any topics
# (no write permissions granted)

# ----------------------------------------------------------------------------
# Configuration Service
# ----------------------------------------------------------------------------
user config-service

# Can publish configuration updates
topic write config/+/#

# Can read configuration requests
topic read config/+/request

# Cannot access device verification topics
# (no permissions for devices/+/verify)

# ----------------------------------------------------------------------------
# Emergency Access
# ----------------------------------------------------------------------------
# Emergency user with time-limited access (manage via certificate expiry)
user emergency-admin

# Full access during emergency
topic readwrite #
topic read $SYS/#

# ----------------------------------------------------------------------------
# Deny Rules (Explicit Denials)
# ----------------------------------------------------------------------------
# Note: Mosquitto doesn't have explicit deny rules
# Access is denied by default if not explicitly granted
#
# Best Practice: Use separate MQTT brokers for different security zones
# rather than complex ACL rules

# ----------------------------------------------------------------------------
# Default Policy
# ----------------------------------------------------------------------------
# By default, all access is denied unless explicitly granted above
# No anonymous access allowed (configured in mosquitto.conf)

# ============================================================================
# ACL Security Notes
# ============================================================================
# ✅ Principle of Least Privilege applied
# ✅ Service accounts have minimal required permissions
# ✅ Devices can only access their own topics
# ✅ Pattern matching prevents topic enumeration
# ✅ Admin access separated from device access
# ✅ Monitoring has read-only access
#
# Security Recommendations:
# 1. Regularly review ACL rules for unused accounts
# 2. Use short-lived certificates for all users
# 3. Rotate admin credentials regularly
# 4. Audit $SYS/# topics for unauthorized access attempts
# 5. Monitor for ACL violations in logs
# 6. Use separate MQTT brokers for different environments
# 7. Implement topic namespace conventions
# 8. Document all service accounts and their purposes
#
# Testing ACLs:
# mosquitto_sub -h localhost -p 8883 \
#   --cafile ca.crt --cert client.crt --key client.key \
#   -t 'devices/test-device/status' -v
# ============================================================================

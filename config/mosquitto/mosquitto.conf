# ============================================================================
# Eclipse Mosquitto MQTT Broker Configuration
# Security-hardened configuration for PKI device verification
# ============================================================================

# ----------------------------------------------------------------------------
# General Settings
# ----------------------------------------------------------------------------
# Persistence
persistence true
persistence_location /mosquitto/data/

# Logging
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# Connection logging
connection_messages true

# ----------------------------------------------------------------------------
# Network Configuration
# ----------------------------------------------------------------------------
# Disable default insecure listener
listener 1883
protocol mqtt
socket_domain ipv4

# TLS listener (primary)
listener 8883
protocol mqtt
socket_domain ipv4

# ----------------------------------------------------------------------------
# TLS/SSL Configuration
# ----------------------------------------------------------------------------
# CA certificate for verifying client certificates
cafile /run/secrets/mqtt_ca_cert

# Server certificate and private key
certfile /run/secrets/mqtt_server_cert
keyfile /run/secrets/mqtt_server_key

# Require client certificates (mutual TLS)
require_certificate true
use_identity_as_username true

# TLS version and ciphers
tls_version tlsv1.3

# Cipher suites (TLS 1.3)
# TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
ciphers ECDHE+AESGCM:ECDHE+CHACHA20:ECDHE+AES256:!aNULL:!MD5:!DSS

# Verify client certificate hostname
use_subject_as_username false

# ----------------------------------------------------------------------------
# Authentication & Authorization
# ----------------------------------------------------------------------------
# Allow anonymous connections (disabled - certificate auth required)
allow_anonymous false

# ACL file for topic-level authorization
acl_file /mosquitto/config/acl.conf

# ----------------------------------------------------------------------------
# Security Settings
# ----------------------------------------------------------------------------
# Maximum packet size (10MB)
max_packet_size 10485760

# Maximum QoS (0, 1, or 2)
max_qos 2

# Retained messages
max_retained_messages 1000

# Maximum keepalive (seconds)
max_keepalive 300

# Message size limit
message_size_limit 10485760

# ----------------------------------------------------------------------------
# Connection Limits
# ----------------------------------------------------------------------------
# Maximum connections per client
max_connections 1000

# Maximum connections from same IP
# max_connections_per_ip 10  # Uncomment if needed

# Persistent client expiration (30 days)
persistent_client_expiration 30d

# ----------------------------------------------------------------------------
# Performance Tuning
# ----------------------------------------------------------------------------
# Memory limit (in bytes)
# memory_limit 104857600  # 100MB

# Queue QoS 0 messages while clients are disconnected
queue_qos0_messages false

# Maximum queued messages
max_queued_messages 1000

# Maximum queued bytes
max_queued_bytes 104857600  # 100MB

# Maximum inflight messages
max_inflight_messages 20

# ----------------------------------------------------------------------------
# Websockets (Disabled for security)
# ----------------------------------------------------------------------------
# If websockets are needed, configure with TLS
# listener 8884
# protocol websockets
# cafile /run/secrets/mqtt_ca_cert
# certfile /run/secrets/mqtt_server_cert
# keyfile /run/secrets/mqtt_server_key

# ----------------------------------------------------------------------------
# Bridge Configuration (if connecting to upstream broker)
# ----------------------------------------------------------------------------
# connection bridge-01
# address upstream-broker.example.com:8883
# topic devices/# both 0
# bridge_cafile /mosquitto/certs/upstream-ca.crt
# bridge_certfile /mosquitto/certs/bridge.crt
# bridge_keyfile /mosquitto/certs/bridge.key
# bridge_tls_version tlsv1.3

# ----------------------------------------------------------------------------
# Plugin Configuration (Optional)
# ----------------------------------------------------------------------------
# Dynamic security plugin (alternative to ACL file)
# plugin /usr/lib/mosquitto_dynamic_security.so
# plugin_opt_config_file /mosquitto/config/dynamic-security.json

# Authentication plugin (if using custom auth)
# auth_plugin /usr/lib/mosquitto-auth-plug.so
# auth_opt_backends mysql,http

# ----------------------------------------------------------------------------
# Monitoring & Statistics
# ----------------------------------------------------------------------------
# System topics ($SYS/#)
sys_interval 60

# ----------------------------------------------------------------------------
# Security Hardening Notes
# ----------------------------------------------------------------------------
# ✅ TLS 1.3 enforced
# ✅ Client certificate authentication required
# ✅ Anonymous connections disabled
# ✅ ACL-based topic authorization
# ✅ Connection and message rate limits
# ✅ Strong cipher suites only
# ✅ Persistent storage for reliability
# ✅ Comprehensive logging enabled
#
# Production Hardening:
# - Monitor $SYS/# topics for anomalies
# - Implement fail2ban for connection flooding
# - Use firewall rules to restrict access
# - Enable audit logging for all auth events
# - Regularly rotate TLS certificates
# - Monitor disk usage (persistence and logs)
# ============================================================================
